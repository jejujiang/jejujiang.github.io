---
layout: default
---

## **[POSIX sh](https://pubs.opengroup.org/onlinepubs/9799919799/)标准语法（可移植性基础）**

POSIX（Portable Operating System Interface）为Unix-like系统定义了一个标准的shell规范，基于**Bourne Shell**。遵守POSIX标准的脚本能在大多数shell中运行（包括bash、zsh、ksh、ash/dash等），但**csh/fish不完全兼容**。

---

### **1. 变量操作**
```sh
# 赋值（等号两边无空格）
name=value

# 引用变量
echo "$name"

# 默认值
${var:-default}      # 如果var未设置或为空，使用default
${var:=default}      # 如果var未设置或为空，设为default
${var:?error_msg}    # 如果var未设置或为空，报错退出
${var:+replacement}  # 如果var已设置且非空，使用replacement
```

### **2. 条件测试**
```sh
# test命令或 [ ]（注意空格）
test "$a" = "$b"
[ "$a" = "$b" ]

# 常用测试操作符
[ -f file ]     # 存在且为普通文件
[ -d dir ]      # 存在且为目录
[ -r file ]     # 可读
[ -n "$str" ]   # 字符串非空
[ -z "$str" ]   # 字符串为空
[ "$a" -eq 1 ]  # 数值相等
[ "$a" -ne 1 ]  # 数值不等
[ "$a" -gt 1 ]  # 大于
[ "$a" -lt 1 ]  # 小于

# 组合条件
[ ! -f file ]                 # 非
[ -f file ] && [ -r file ]    # 与
[ -f file ] || [ -d file ]    # 或
```

### **3. 流程控制**
```sh
# if语句
if condition; then
    commands
elif condition; then
    commands
else
    commands
fi

# case语句
case $var in
    pattern1)
        commands ;;
    pattern2|pattern3)
        commands ;;
    *)
        commands ;;
esac

# for循环（遍历列表）
for var in item1 item2 item3; do
    echo "$var"
done

# while循环
while condition; do
    commands
done

# until循环
until condition; do
    commands
done
```

### **4. 函数**
```sh
# 定义函数
func_name() {
    commands
    return  # 可选的返回值（0-255）
}

# 调用函数
func_name arg1 arg2

# 函数内获取参数
func_name() {
    echo "第一个参数: $1"
    echo "参数个数: $#"
    echo "所有参数: $@"
}
```

### **5. 位置参数和特殊变量**
```sh
$0      # 脚本名
$1, $2  # 第1、2个参数
$#      # 参数个数
$@      # 所有参数（每个参数独立）
$*      # 所有参数（作为一个字符串）
$?      # 上条命令的退出状态
$$      # 当前shell的PID
$!      # 最后一个后台进程的PID
```

### **6. 引号和转义**
```sh
# 单引号：完全字面值
echo '$PATH'      # 输出 $PATH

# 双引号：允许变量和命令替换
echo "$PATH"      # 输出PATH的值

# 反斜杠转义
echo "Line 1\nLine 2"  # \n不会解释为换行
echo -e "Line 1\nLine 2"  # 需-e选项（非POSIX）
```

### **7. 命令执行与替换**
```sh
# 命令替换（两种形式，推荐第一种）
$(command)    # POSIX标准
`command`     # 传统形式

# 后台执行
command &

# 顺序执行
command1 ; command2
command1 && command2  # 前一个成功才执行下一个
command1 || command2  # 前一个失败才执行下一个
```

### **8. 输入/输出重定向**
```sh
# 标准重定向
command > file      # 覆盖输出
command >> file     # 追加输出
command < file      # 输入重定向

# 错误重定向
command 2> file     # 标准错误重定向
command 2>&1        # 标准错误合并到标准输出
command > file 2>&1 # 两者都重定向到文件
```

### **9. 算术运算**
```sh
# 使用 $(( )) 进行整数运算
result=$((a + b))
result=$((a * (b + c)))

# 运算符
+ - * / %    # 加减乘除取余
< > <= >= == !=  # 比较
&& || !      # 逻辑
```

### **10. 模式匹配**
```sh
# 通配符
*           # 匹配任意字符
?           # 匹配单个字符
[abc]       # 匹配a、b、c中任意一个
[a-z]       # 匹配a到z中任意一个
[!abc]      # 匹配非a、b、c的任意字符
```

---

### **POSIX与非POSIX主要差异**

| 功能 | POSIX | 非POSIX扩展（避免使用） |
|------|-------|-------------------|
| 数组 | 不支持 | `array=(1 2 3); echo ${array[0]}` |
| 字符串替换 | `${var#pattern}` | `${var//pattern/replace}` |
| 进程替换 | 不支持 | `<(command)` 或 `>(command)` |
| 通配符扩展 | 有限 | `**`（递归匹配） |
| 测试操作符 | `[ ]` | `[[ ]]`（bash/zsh等） |
| 函数定义 | `func() { ... }` | `function func { ... }` |
| 局部变量 | 无 | `local var=value` |

---

### **编写可移植脚本的要点**
1. **脚本首行**：`#!/bin/sh`（而非`#!/bin/bash`）
2. **测试命令**：使用`[ ]`而不是`[[ ]]`
3. **字符串处理**：优先使用外部命令`cut`、`sed`、`awk`而非shell扩展
4. **错误处理**：检查命令退出状态`$?`
5. **变量引用**：始终用双引号引用变量，如`"$var"`
6. **命令替换**：使用`$(command)`而非反引号`` `command` ``
7. **避免使用**：数组、关联数组、进程替换、`let`、`select`等

### **检查脚本兼容性**
```sh
# 使用dash检查（严格POSIX shell）
dash -n script.sh  # 检查语法
dash script.sh     # 实际执行

# 或使用checkbashisms工具（Debian/Ubuntu）
checkbashisms script.sh
```

遵循POSIX标准可以确保脚本在大多数Unix/Linux系统上运行，包括嵌入式系统使用的BusyBox ash。
